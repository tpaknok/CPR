---
title: "Empirical Analyses with CPR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Empirical Analyses with CPR}
  %\VignettePackage{CPR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Setup

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This is an R Markdown document describing the empirical analyses conducted in Tsang et al. (2024). Again, you will need to install and load multiple packages and data.

```{r,message=FALSE}
library(phytools)
library(tidyverse)
library(CPR)
data(KSR)
data(KSR_MLtree)
data(KSR_EF)

excluded <- anti_join(KSR, KSR_EF, by = c("PLOT" = "Plot"))
KSR <- semi_join(KSR, KSR_EF, by = c("PLOT" = "Plot"))
KSR_EF <- KSR_EF %>% arrange(factor(Plot,levels=KSR$PLOT))

KSR_misc <- KSR$PLOT
KSR <- KSR[,-1]
KSR[is.na(KSR)] <- 0
KSR <- KSR[rowSums(KSR) > 0,]

KSR_MLtree <- keep.tip(KSR_MLtree,colnames(KSR))
VCV_sp <- vcv(KSR_MLtree) #species level phyologenetic covariance matrix using default (Brownian) model
VCV_sp <- VCV_sp[order(rownames(VCV_sp)),order(colnames(VCV_sp))]
VCV_comm <- get_comm_pair_r(KSR,VCV_sp)
```

The KSR_EF data have multiple ecosystem function.

```{r}
head(KSR_EF)
```

## Data description

| Variable         | Description                                                      |
|-----------------|------------------------------------------------------|
| Plot             | Plot identity                                                    |
| Real.rich        | Number of species planted                                        |
| Legume           | ?                                                                |
| Hed              | ?                                                                |
| PD               | ?                                                                |
| MNND             | ?                                                                |
| MPD              | ?                                                                |
| H                | ?                                                                |
| Simp             | ?                                                                |
| biomass2012      | Biomass measured in 2012                                         |
| litter2012       | Amount of litter measured in 2012                                |
| biomass2013      | Biomass measured in 2013                                         |
| biomass2014      | Biomass measured in 2014                                         |
| ave.biomass      | Average biomass across years                                     |
| light.tau        | ?                                                                |
| LAI              | Leaf area index, a simplified dimension of structural complexity |
| C.change.deep    | ?                                                                |
| C.change.surf    | ?                                                                |
| N.change.deep    | delta 15N change of deep soil                                    |
| N.change.surf    | delta 15N change of surface soil                                 |
| mean.N.change    | delta 15N change averaged across surface and deep soil           |
| poll_total       | Total number of pollinators                                      |
| flwr_total       | Total number of flowers                                          |
| Mass.loss.1month | Decomposition after 1 month                                      |
| Mass.loss.2monh  | Decomposition after 2 months                                     |
| GRASS            | ?                                                                |
| SOAL             | ?                                                                |
| MOFI             | ?                                                                |
| ASTU             | ?                                                                |
| DECA             | ?                                                                |
| Damage_effect    | Damage reduction effect                                          |
| bugs             | Total number of arthropods                                       |
| bug.rich         | Species richness of arthropods                                   |

## Empirical analyses

We repeated the analyses in [Cadotte et al. (2017)](https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/ecy.2045?casa_token=dROW6fWW92EAAAAA%3AuXcUC3seoCFkzpoV1Zb6_PSzxjkN7_8H1jhBYjjzTiF0-g3tPsfV1lFQVN4k1QiNRTLwqWbl4PW_nQ), involving ten ecosystem functions. If only one ecosystem function is of interest (or if you don't mind your code is clunky), you can just use INLA and write similar functions ten times. For example...

```{r,message=F}
library(nlme)
```

```{r,message=F,eval=F}
KSR_EF$log_flwr_total <- log10(KSR_EF$flwr_total+1) #log-transforming floral abundance to facilitate covnergence in INLA

KSR_EF$comm <- 1:nrow(KSR_EF) #need to create an unique identifier for each comm in INLA
m <- lm(log_flwr_total~Real.rich,data=KSR_EF)

sdres <- sd(residuals(m))
param <- c(3*sdres,0.01)
prior1 <- list(prec=list(prior="pc.prec"),param=param) #you don't need to follow everything here. You can specify your own prior too.

f <- log_flwr_total~Real.rich+f(comm,model="generic0",Cmatrix=P.lambda,hyper=list(prec = prior1)) #start with the formula. Note that P.lambda is just a placeholder 
#You can also provide multiple prior

ML.opt2<-optim(runif(1,0.2,0.8),
               likelihood.lambda.INLA,
               inla_formula= f,
               family="gaussian",
               data=KSR_EF,
               phyV=VCV_sp,
               comm=KSR,
               prior = list(prior1 = prior1),
               control.compute = list(waic=T),
               method="L-BFGS-B",
               lower=0.0,
               upper=1.0,
               control=list(factr=1e9)) #SLOW

lambda_INLA<-ML.opt2$par
wAIC <- ML.opt2$value
VCV_sp_INLA <- VCV_sp*lambda_INLA
diag(VCV_sp_INLA) <- diag(VCV_sp)
C.lambda.INLA<- get_comm_pair_r(KSR,VCV_sp_INLA) 

prec.mat.INLA <- solve(C.lambda.INLA) #note that INLA requires a precision matrix, not a VCV

optim_m <- inla(log_flwr_total~Real.rich+f(comm,
                                           model="generic0",
                                           Cmatrix=prec.mat.INLA,
                                           hyper=list(prec = prior1)),
                data=KSR_EF)

lm_m <- inla(log_flwr_total~Real.rich,
                data=KSR_EF)

summary(optim_m)
summary(lm_m)

```

In my case, I used lapply to do it. So the coding is more complicated.

```{r,message=F,eval=F}
library(tidyverse)
library(nlme)
ef_name <- c("litter2012","ave.biomass","LAI","bug.rich","bugs","poll_total","log_flwr_total","Mass.loss.2month","Damage_effect","mean.N.change") #ecosystem functions analyzed
ef <- KSR_EF[,ef_name]
C <- get_comm_pair_r(KSR,VCV_sp)

f <- y~x+f(comm,model="generic0",Cmatrix=P.lambda,hyper=list(prec = prior1))
family <- ifelse(ef_name == "bug.rich" | ef_name == "bugs" | ef_name == "poll_total",
                 "poisson",
                 "gaussian")

ef_empiricial <- function(ef_data,x,VCV_sp,names,ef_properties,comm,family) {
  print(ef_properties)
  y <- ef_data
  df <- data.frame(y=y,x=x)
  df$comm <- 1:nrow(df)
  
  m <- glm(y~x,
           family = family,
           data = df)
  
  summary(m)
  m_sig <- summary(m)$coefficients[2,4]

  sdres <- sd(residuals(m))
  param <- c(3*sdres,0.01)
  prior1 <- list(prec=list(prior="pc.prec"),param=param)
  
  ML.opt2<-optim(runif(1,0.2,0.8),
                 likelihood.lambda.INLA,
                 inla_formula = f,
                 family = family,
                 data = df,
                 phyV = VCV_sp,
                 comm = KSR,
                 prior = list(prior1 = prior1),
                 control.compute = list(waic=T),
                 method = "L-BFGS-B",
                 lower = 0.0,
                 upper = 1.0,
                 control = list(factr=1e9))
  
  lambda_INLA<-ML.opt2$par
  wAIC <- ML.opt2$value
  V_INLA <- VCV_sp*lambda_INLA
  diag(V_INLA) <- diag(VCV_sp)
  C.lambda.INLA<- get_comm_pair_r(comm,V_INLA) 
  
  newobs <- data.frame(y=NA,x=unique(x),comm=NA)
  INLA_df <- rbind(df,newobs)
  
  m2_INLA_LM <- inla(y~x,
                     data=INLA_df,
                     family=family,
                     control.compute = list(dic=T,waic=T))
  m2_INLA_LM <- inla.rerun(m2_INLA_LM)
  wAIC_LM <- m2_INLA_LM$waic$waic
  m2_INLA_LM_r2<- cor(m2_INLA_LM$summary.fitted.values[1:(nrow(df)),"mean"],df$y)^2
  
  prec.mat.INLA <- solve(C.lambda.INLA)
  m2_INLA_optim <- inla(y~x+f(comm,
                              model="generic0",
                              Cmatrix=prec.mat.INLA,
                              prior = "pc.prec",
                              hyper= c(3*sd(residuals(m)),0.01)),
                        family = family,
                        data = INLA_df,control.predictor=list(compute=TRUE),
                        control.compute = list(dic=T,waic=T),
                        safe=T,
                        control.inla = list(tolerance = 1e-10))
  m2_INLA_optim <- inla.rerun(m2_INLA_optim) # https://groups.google.com/g/r-inla-discussion-group/c/qkoV9ZtA1Wo
  m2_INLA_optim <- inla.rerun(m2_INLA_optim) # https://groups.google.com/g/r-inla-discussion-group/c/qkoV9ZtA1Wo
  
  summary(m2_INLA_optim)
  m2_INLA_optim_predict <- m2_INLA_optim$summary.fitted.values[-1:-(nrow(df)),]
  m2_INLA_optim_predict <- data.frame(newobs$x,m2_INLA_optim_predict[,c("mean","0.025quant","0.975quant")])
  m2_INLA_optim_predict$sig <- ifelse(sign(m2_INLA_optim$summary.fixed)[2,3] == sign(m2_INLA_optim$summary.fixed)[2,5],-1,1)
  m2_INLA_optim_r2 <- cor(m2_INLA_optim$summary.fitted.values[1:nrow(df),"mean"],df$y)^2
  
  library(ggeffects)
  m_predict <- data.frame(ggeffect(m,terms="x"),sig=m_sig)
  m_predict <- m_predict[,c(1,2,4,5,7)]
  colnames(m2_INLA_optim_predict) <- colnames(m_predict)
  
  ###summarize the data into a dataframe
  predict_df <- rbind(cbind(m_predict,
                            model="OLS",
                            ef=ef_properties,
                            lambda=NA,
                            hyper_Gaussian = NA, 
                            hyper_Comm = NA,
                            wAIC = wAIC_LM,
                            r2=m2_INLA_LM_r2,
                            mean=m2_INLA_LM$summary.fixed[2,1],
                            lower_quant=m2_INLA_LM$summary.fixed[2,3],
                            upper_quant=m2_INLA_LM$summary.fixed[2,5]),
                      cbind(m2_INLA_optim_predict,
                            model="Optimized INLA",
                            ef=ef_properties,
                            lambda=lambda_INLA,
                            hyper_Gaussian=m2_INLA_optim$summary.hyperpar[1,1],
                            hyper_Comm =m2_INLA_optim$summary.hyperpar[2,1],
                            wAIC=wAIC,
                            r2=m2_INLA_optim_r2,
                            mean=m2_INLA_optim$summary.fixed[2,1],
                            lower_quant=m2_INLA_optim$summary.fixed[2,3],
                            upper_quant=m2_INLA_optim$summary.fixed[2,5]))
  
  return(predict_df)
}

df <- data.frame(x=KSR_EF$Real.rich) #seems that ggeffect can only extract variables from global environments
predict_df <- lapply(1:ncol(ef),function(x) ef_empiricial(ef_data=ef[,x],
                                                          x=KSR_EF$Real.rich,
                                                          VCV_sp=VCV_sp,
                                                          ef_properties=ef_name[x],
                                                          comm=KSR,
                                                          family=family[x]))

predict_df <- do.call(rbind,predict_df)
predict_df$x <- predict_df$x
predict_df$sig_binary <- ifelse(predict_df$sig < 0.05,"Significant","Insignificant")

```
Now let's visualize the findings

```{r,fig.width=unit(10,"cm"),fig.height=unit(20,"cm"),eval=F}
library(ggplot2)
library(tidyverse)
plot_data <- KSR_EF %>% 
  select(any_of(ef_name)|"Real.rich") %>%
  #select(contains("2015.2017") | contains("NumSp")) %>%
  pivot_longer(!Real.rich,names_to="ef")

plot_data$ef <- fct_relevel(plot_data$ef,
                            "litter2012",
                            "ave.biomass",
                            "LAI",
                            "poll_total",
                            "log_flwr_total",
                            "Mass.loss.2month",
                            "Damage_effect",
                            "mean.N.change",
                            "bugs",
                            "bug.rich")

predict_df$ef <- fct_relevel(predict_df$ef,
                             "litter2012",
                             "ave.biomass",
                             "LAI",
                             "poll_total",
                             "log_flwr_total",
                             "Mass.loss.2month",
                             "Damage_effect",
                             "mean.N.change",
                             "bugs",
                             "bug.rich")

predict_df$ratio <- predict_df$hyper_Gaussian/predict_df$hyper_Comm
predict_df$ratio <- (1/predict_df$hyper_Gaussian)/(1/predict_df$hyper_Comm)

p <- ggplot(data=predict_df)+
  geom_jitter(data=plot_data,aes(y=value,x=Real.rich),width=0)+
  geom_line(aes(y=predicted,x=x,colour=model,linetype=sig_binary))+
  geom_ribbon(aes(y=predicted,x=x,fill=model,ymin=conf.low,ymax=conf.high),alpha=0.3,colour="transparent")+
  facet_wrap(~ef,scales="free",nrow=5,ncol=2)+
  theme_classic()+
  labs(x="Species richness",y="Ecosystem Function",colour="Model",fill="Model",linetype="Significance")+
  scale_linetype_manual(values=c(2,1))+
  scale_colour_manual(values=c("#000000","#E69F00"))+
  scale_fill_manual(values=c("#000000","#E69F00"))+
  theme(legend.position="bottom")

plot(p)
```
