<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="CPR">
<title>Empirical Analyses with CPR - Single Function • CPR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Empirical Analyses with CPR - Single Function">
<meta property="og:description" content="CPR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">CPR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Empirical_multiple.html">Empirical Analyses with CPR - Multiple Functions</a>
    <a class="dropdown-item" href="../articles/Empirical_single.html">Empirical Analyses with CPR - Single Function</a>
    <a class="dropdown-item" href="../articles/Simulation.html">Simulation with CPR</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/tpaknok/CPR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Empirical Analyses with CPR - Single Function</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tpaknok/CPR/blob/HEAD/vignettes/Empirical_single.Rmd" class="external-link"><code>vignettes/Empirical_single.Rmd</code></a></small>
      <div class="d-none name"><code>Empirical_single.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>This is an R Markdown document describing how to use CPR to conduct
BEF regression, or any community-level analyses. You will need to
install and load multiple packages and data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/liamrevell/phytools" class="external-link">phytools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tpaknok/CPR" class="external-link">CPR</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"KSR"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"KSR_MLtree"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"KSR_EF"</span><span class="op">)</span></span></code></pre></div>
<p>Let’s get the variane covariance matrix at species and community
level.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">VCV_sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/vcv.phylo.html" class="external-link">vcv</a></span><span class="op">(</span><span class="va">KSR_MLtree</span><span class="op">)</span> <span class="co">#species level phyologenetic covariance matrix using default (Brownian) model</span></span>
<span><span class="va">VCV_sp</span> <span class="op">&lt;-</span> <span class="va">VCV_sp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">VCV_sp</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">VCV_sp</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">VCV_comm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_comm_pair.html">get_comm_pair_r</a></span><span class="op">(</span><span class="va">KSR</span>,<span class="va">VCV_sp</span><span class="op">)</span></span>
<span><span class="va">VCV_comm</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt;           [,1]      [,2]      [,3]      [,4]      [,5]</span></span>
<span><span class="co">#&gt; [1,] 1.0000000 0.7031681 0.5639611 0.5601336 0.7539047</span></span>
<span><span class="co">#&gt; [2,] 0.7031681 1.0000000 0.5458038 0.5420995 0.7048548</span></span>
<span><span class="co">#&gt; [3,] 0.5639611 0.5458038 1.0000000 0.9932127 0.5749535</span></span>
<span><span class="co">#&gt; [4,] 0.5601336 0.5420995 0.9932127 1.0000000 0.5710514</span></span>
<span><span class="co">#&gt; [5,] 0.7539047 0.7048548 0.5749535 0.5710514 1.0000000</span></span></code></pre></div>
<p>The KSR_EF data have multiple ecosystem function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">KSR_EF</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Plot Real.rich litter2012 ave.biomass  LAI mean.N.change poll_total flwr_total Mass.loss.2month Damage_effect bugs bug.rich</span></span>
<span><span class="co">#&gt; 1   X2         1      79.05    32.97333 1.67       -0.0015         20 43113.5000            3.362     0.0000000    9        7</span></span>
<span><span class="co">#&gt; 2   X3         4      74.23    82.41000 5.53       -0.0275         53  2126.1429            3.718     0.3001195    7        6</span></span>
<span><span class="co">#&gt; 3   X4         2      34.50    62.92667 3.04        0.0060        150   324.4286            3.521     0.4195279    4        2</span></span>
<span><span class="co">#&gt; 4   X7         1      36.32    34.38333 3.42       -0.0575          0     0.0000            3.328     0.0000000    5        3</span></span>
<span><span class="co">#&gt; 5   X8         3      21.46   147.05667 7.14       -0.0070          0     0.0000            3.608     2.7460093    4        4</span></span>
<span><span class="co">#&gt; 6   X9         1      37.26    33.80333 1.01        0.0415          0     0.0000            3.627     0.0000000   11        7</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-description">Data Description<a class="anchor" aria-label="anchor" href="#data-description"></a>
</h2>
<table class="table">
<colgroup>
<col width="23%">
<col width="76%">
</colgroup>
<thead><tr class="header">
<th>Variable</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Plot</td>
<td>Plot identity</td>
</tr>
<tr class="even">
<td>Real.rich</td>
<td>Number of species planted</td>
</tr>
<tr class="odd">
<td>litter2012</td>
<td>Amount of litter measured in 2012</td>
</tr>
<tr class="even">
<td>ave.biomass</td>
<td>Average biomass across 2012-2014</td>
</tr>
<tr class="odd">
<td>LAI</td>
<td>Leaf area index, a simplified dimension of structural
complexity</td>
</tr>
<tr class="even">
<td>mean.N.change</td>
<td>delta 15N change averaged across surface and deep soil</td>
</tr>
<tr class="odd">
<td>poll_total</td>
<td>Total number of pollinators</td>
</tr>
<tr class="even">
<td>flwr_total</td>
<td>Total number of flowers</td>
</tr>
<tr class="odd">
<td>Mass.loss.2month</td>
<td>Decomposition after 2 months</td>
</tr>
<tr class="even">
<td>Damage_effect</td>
<td>Damage reduction effect</td>
</tr>
<tr class="odd">
<td>bugs</td>
<td>Total number of arthropods</td>
</tr>
<tr class="even">
<td>bug.rich</td>
<td>Species richness of arthropods</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="empirical-analyses---single-function">Empirical Analyses - Single Function<a class="anchor" aria-label="anchor" href="#empirical-analyses---single-function"></a>
</h2>
<p>We repeated the analyses in <a href="https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/ecy.2045?casa_token=dROW6fWW92EAAAAA%3AuXcUC3seoCFkzpoV1Zb6_PSzxjkN7_8H1jhBYjjzTiF0-g3tPsfV1lFQVN4k1QiNRTLwqWbl4PW_nQ" class="external-link">Cadotte
et al. (2017)</a>, involving ten ecosystem functions. If only one
ecosystem function is of interest (or if you don’t mind your code is
clunky), you can just use INLA and write similar functions ten times.
For example, let’s analyze flower abundance.</p>
<p>INLA is a very powerful package, but can be a bit complicated to use.
As it is a Bayesian analysis, we have to specify priors. INLA has
different default priors and check their <a href="https://becarioprecario.bitbucket.io/inla-gitbook/ch-priors.html" class="external-link">website</a>
if you are interested.</p>
<p>For simplicty’s sake, we will use the default prior for the random
and fixed effects, which are all uninformative in this case. However,
for the dispersion parameter of tweedie, we actually used a gaussian
distribution N~(0,2). Note that the prior is in log-scale in the <a href="https://inla.r-inla-download.org/r-inla.org/doc/likelihood/tweedie.pdf" class="external-link">internal
calculation of INLA</a>. That’s because the default setting loggamma
(100,100) seems to have a very narrow range, thus becoming very
informative, at least for our dataset.</p>
<p>Generally, you should think carefully about prior constructions. <a href="https://nsojournals.onlinelibrary.wiley.com/doi/full/10.1111/oik.05985" class="external-link">Default
priors are not always uninformative</a>, and they can have a huge
influence on the data!</p>
<p>The syntax of INLA is very different with other packages like lme4
and glmmTMB. For random effect, you need to use f() and provide all the
necessary argument. If you have manually computed a covariance matrix,
you need to first convert it to a precision matrix, and throw it to the
Cmatrix argument. Also, you need to set model as “generic0”.</p>
<p>If you use CPR, you only need to supply the species-level covariance
matrix to VCV_sp, and then add “Phylo” in the Cmatrix argument. Phylo is
just a placeholder and the internal calculation of CPR will
automatically convert the covariance matrix to a precision matrix (or
even optimize the covariance matrix if you wish to do so).</p>
<p>You also need to add the ID of each plot, and the CPR function
internally will create a column named “comm” for it automatically.</p>
<p>INLA sometimes might fail to run, and they will rerun automatically.
You don’t need to worry about that.</p>
<p>If you choose to optimize the phylogenetic signal, this might take a
while to run! So be patient!</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inla_m</span> <span class="op">&lt;-</span> <span class="fu">CPR</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">bugs</span><span class="op">~</span><span class="va">Real.rich</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">comm</span>,model<span class="op">=</span><span class="st">"generic0"</span>,Cmatrix<span class="op">=</span><span class="va">Phylo</span><span class="op">)</span>,</span>
<span>              priors<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>              df <span class="op">=</span> <span class="va">KSR_EF</span>,</span>
<span>              VCV_sp <span class="op">=</span> <span class="va">VCV_sp</span>,</span>
<span>              comm<span class="op">=</span><span class="va">KSR</span>,</span>
<span>              family<span class="op">=</span><span class="st">"nbinomial"</span>,</span>
<span>              optim.lambda <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "bugs"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">inla_m</span><span class="op">$</span><span class="va">best_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt;    c("inla.core(formula = formula, family = family, contrasts = contrasts, ", " data = data, quantiles = quantiles, </span></span>
<span><span class="co">#&gt;    E = E, offset = offset, ", " scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, ", " lp.scale </span></span>
<span><span class="co">#&gt;    = lp.scale, link.covariates = link.covariates, verbose = verbose, ", " lincomb = lincomb, selection = selection, </span></span>
<span><span class="co">#&gt;    control.compute = control.compute, ", " control.predictor = control.predictor, control.family = control.family, </span></span>
<span><span class="co">#&gt;    ", " control.inla = control.inla, control.fixed = control.fixed, ", " control.mode = control.mode, </span></span>
<span><span class="co">#&gt;    control.expert = control.expert, ", " control.hazard = control.hazard, control.lincomb = control.lincomb, ", " </span></span>
<span><span class="co">#&gt;    control.update = control.update, control.lp.scale = control.lp.scale, ", " control.pardiso = control.pardiso, </span></span>
<span><span class="co">#&gt;    only.hyperparam = only.hyperparam, ", " inla.call = inla.call, inla.arg = inla.arg, num.threads = num.threads, </span></span>
<span><span class="co">#&gt;    ", " keep = keep, working.directory = working.directory, silent = silent, ", " inla.mode = inla.mode, safe = </span></span>
<span><span class="co">#&gt;    FALSE, debug = debug, .parent.frame = .parent.frame)" ) </span></span>
<span><span class="co">#&gt; Time used:</span></span>
<span><span class="co">#&gt;     Pre = 0.201, Running = 0.253, Post = 0.182, Total = 0.636 </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;              mean    sd 0.025quant 0.5quant 0.975quant  mode kld</span></span>
<span><span class="co">#&gt; (Intercept) 2.117 0.355      1.382    2.129      2.784 2.129   0</span></span>
<span><span class="co">#&gt; Real.rich   0.073 0.098     -0.119    0.074      0.266 0.073   0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;   Name     Model</span></span>
<span><span class="co">#&gt;     comm Generic0 model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model hyperparameters:</span></span>
<span><span class="co">#&gt;                                                        mean    sd 0.025quant 0.5quant 0.975quant mode</span></span>
<span><span class="co">#&gt; size for the nbinomial observations (1/overdispersion) 2.53 0.514      1.672     2.48       3.68 2.38</span></span>
<span><span class="co">#&gt; Precision for comm                                     2.37 1.318      0.758     2.07       5.76 1.58</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Watanabe-Akaike information criterion (WAIC) ...: 617.33</span></span>
<span><span class="co">#&gt; Effective number of parameters .................: 11.73</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Marginal log-Likelihood:  -865.84 </span></span>
<span><span class="co">#&gt;  is computed </span></span>
<span><span class="co">#&gt; Posterior summaries for the linear predictor and the fitted values are computed</span></span>
<span><span class="co">#&gt; (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="residual-checking">Residual Checking<a class="anchor" aria-label="anchor" href="#residual-checking"></a>
</h2>
<p>Let’s do some model diagnostics to make sure our model makes sense.
First, we will use the function INLA_simulate to obtain simulated
response from our model. Then we will put it in DHARMa and conduct
different diagnostics.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://florianhartig.github.io/DHARMa/" class="external-link">DHARMa</a></span><span class="op">)</span></span>
<span><span class="va">sres</span> <span class="op">&lt;-</span> <span class="fu">INLA_simulate</span><span class="op">(</span><span class="va">inla_m</span><span class="op">$</span><span class="va">best_model</span><span class="op">)</span></span>
<span><span class="va">DHARMa_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/createDHARMa.html" class="external-link">createDHARMa</a></span><span class="op">(</span><span class="va">sres</span>,</span>
<span>                           <span class="va">KSR_EF</span><span class="op">$</span><span class="va">bugs</span>,</span>
<span>                           fittedPredictedResponse<span class="op">=</span><span class="va">inla_m</span><span class="op">$</span><span class="va">predictedfittedresponse</span>,</span>
<span>                           integerResponse <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">DHARMa_res</span>,quantreg<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figure/Diagnostic-1.png" alt="Outputs from DHARMa for the negative binomial model"><div class="figcaption">Outputs from DHARMa for the negative binomial
model</div>
</div>
<p>You can see that our data don’t deviate a lot from the expected line
in the QQ plot, which is a good thing. Also, there is no obvious pattern
in the residual graph….so our model should be ok.</p>
<p>Now let’s try to run the analyses with poisson distribution and see
what happens. For the hyperparameter of gaussian distribution we will
use default settings in INLA.</p>
</div>
<div class="section level2">
<h2 id="a-bad-example">A bad example<a class="anchor" aria-label="anchor" href="#a-bad-example"></a>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inla_m2</span> <span class="op">&lt;-</span> <span class="fu">CPR</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">bugs</span><span class="op">~</span><span class="va">Real.rich</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">comm</span>,model<span class="op">=</span><span class="st">"generic0"</span>,Cmatrix<span class="op">=</span><span class="va">Phylo</span><span class="op">)</span>,</span>
<span>              priors<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>              df <span class="op">=</span> <span class="va">KSR_EF</span>,</span>
<span>              VCV_sp <span class="op">=</span> <span class="va">VCV_sp</span>,</span>
<span>              comm<span class="op">=</span><span class="va">KSR</span>,</span>
<span>              family<span class="op">=</span><span class="st">"poisson"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "bugs"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">inla_m2</span><span class="op">$</span><span class="va">best_m</span><span class="op">)</span></span>
<span><span class="co">#&gt; Length  Class   Mode </span></span>
<span><span class="co">#&gt;      0   NULL   NULL</span></span>
<span></span>
<span><span class="va">sres2</span> <span class="op">&lt;-</span> <span class="fu">INLA_simulate</span><span class="op">(</span><span class="va">inla_m2</span><span class="op">$</span><span class="va">best_model</span><span class="op">)</span></span>
<span><span class="va">DHARMa_res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DHARMa/man/createDHARMa.html" class="external-link">createDHARMa</a></span><span class="op">(</span><span class="va">sres2</span>,</span>
<span>                           <span class="va">KSR_EF</span><span class="op">$</span><span class="va">bugs</span>,</span>
<span>                           <span class="va">inla_m2</span><span class="op">$</span><span class="va">best_model</span><span class="op">$</span><span class="va">predictedfittedresponse</span>,</span>
<span>                           integerResponse<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">DHARMa_res2</span>,quantreg<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figure/gaussian-1.png" alt="Outputs from DHARMa for the poisson model"><div class="figcaption">Outputs from DHARMa for the poisson model</div>
</div>
<p>Clearly a worse fit than negative binomial! We knew that poisson
distributions often fail to describe ecological data properly.</p>
<p>There are other functions in DHARMa, so check out the package to
build robust models!</p>
</div>
<div class="section level2">
<h2 id="making-figures">Making figures<a class="anchor" aria-label="anchor" href="#making-figures"></a>
</h2>
<p>Let’s say we want to visualize the predicted relationships between
arthropod abundance and species richness. Note that predict functions
doesn’t work in INLA, and many packages don’t support INLA too. If you
use CPR, the result will automatically provide predicted relationships
and you can pass it to ggplot to make pretty figures. For each variable,
CPR will create a list. Thus for example we can extract the predicted
relationship from inla_m$prediction$Real.rich if we want to visualize
the expected effect of species richness.</p>
<p>Of course you can just visualize the effect with/without phylogeny,
depending on which one fits better. Anyway, based on our models, we can
conclude</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">KSR_EF</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Real.rich</span>,y<span class="op">=</span><span class="va">bugs</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">inla_m</span><span class="op">$</span><span class="va">prediction</span><span class="op">$</span><span class="va">Real.rich</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Real.rich</span>,</span>
<span>                                                 y<span class="op">=</span><span class="va">`0.5quant`</span>,</span>
<span>                                                 colour<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">inla_m</span><span class="op">$</span><span class="va">prediction</span><span class="op">$</span><span class="va">Real.rich</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Real.rich</span>,</span>
<span>                                                   y<span class="op">=</span><span class="va">`0.5quant`</span>,</span>
<span>                                                   ymin<span class="op">=</span><span class="va">`0.025quant`</span>,</span>
<span>                                                   ymax<span class="op">=</span><span class="va">`0.975quant`</span>,</span>
<span>                                                   fill<span class="op">=</span><span class="va">model</span>,</span>
<span>                                                   <span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#000000"</span>,<span class="st">"#E69F00"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#000000"</span>,<span class="st">"#E69F00"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Species Richness"</span>,y <span class="op">=</span> <span class="st">"Arthropod Abundance"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figure/unnamed-chunk-4-1.png" alt="Predicted effects of species richness on arthropod abundance"><div class="figcaption">Predicted effects of species richness on
arthropod abundance</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Toby Pak Nok Tsang.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
